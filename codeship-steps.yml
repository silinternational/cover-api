- type: parallel
  name: test
  steps:

  - name: test
    service: app
    command: ./codeship-test.sh

  - name: apidocs
    service: docs
    tag: develop
    command: ./build-push-api-docs.sh

- name: push_develop_timestamp
  service: binary
  type: push
  image_name: 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-stg
  image_tag: "{{.Timestamp}}"
  tag: develop
  registry: https://369020531563.dkr.ecr.us-east-1.amazonaws.com
  dockercfg_service: awsgenerator

- name: push_develop_develop
  service: binary
  type: push
  image_name: 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-stg
  image_tag: "develop"
  tag: develop
  registry: https://369020531563.dkr.ecr.us-east-1.amazonaws.com
  dockercfg_service: awsgenerator

- name: push_production_timestamp
  service: binary
  type: push
  image_name: 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-prod
  image_tag: "{{.Timestamp}}"
  tag: main
  registry: https://369020531563.dkr.ecr.us-east-1.amazonaws.com
  dockercfg_service: awsgenerator

- name: push_production_latest
  service: binary
  type: push
  image_name: 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-prod
  image_tag: "latest"
  tag: main
  registry: https://369020531563.dkr.ecr.us-east-1.amazonaws.com
  dockercfg_service: awsgenerator

- type: parallel
  name: deploy_and_scan
  steps:

  - name: scan_develop
    service: deepfactor
    tag: develop
    command: dfctl scan 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-stg:develop

  - name: scan_latest
    service: deepfactor
    tag: main
    command: dfctl scan 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-prod:latest

  - name: deploy_staging_web
    service: ecsdeploy
    tag: develop
    command: "-c appsdev-stg -n cover-api -i 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-stg -e CI_TIMESTAMP -t 300 --max-definitions 10"

  - name: deploy_production_web
    service: ecsdeploy
    tag: main
    command: "-c appsdev-prod -n cover-api -i 369020531563.dkr.ecr.us-east-1.amazonaws.com/cover-prod -e CI_TIMESTAMP -t 300 --max-definitions 10"
